import 'package:flutter/material.dart';
import 'package:flutter_application_1/data/auth/auth_notifier.dart';
import 'package:flutter_application_1/screens/home_screen.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

class LoginScreen extends ConsumerWidget {
  LoginScreen({super.key});

  final TextEditingController _loginController = TextEditingController();
  final TextEditingController _passwordController = TextEditingController();

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final authAsynsValue = ref.watch(authNotifierProvider);
    final isLoading = authAsynsValue.isLoading;
    final token = authAsynsValue.value;

    final isLoggedIn = token != null && token.isNotEmpty;

    ref.listen<AsyncValue<String>>(authNotifierProvider, (previous, next) {
      if (next.hasError && context.mounted) {
        ScaffoldMessenger.of(
          context,
        ).showSnackBar(SnackBar(content: Text("–æ—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ${next.error}")));
      } else if (next.hasValue &&
          next.value!.isNotEmpty &&
          previous?.isLoading == true) {
        if (context.mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(content: Text('–í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω! –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...')),
          );

          // üîë –ö–ª—é—á–µ–≤–æ–π –º–æ–º–µ–Ω—Ç: –ù–∞–≤–∏–≥–∞—Ü–∏—è –Ω–∞ HomeScreen
          // pushAndRemoveUntil —É–¥–∞–ª—è–µ—Ç –≤—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –º–∞—Ä—à—Ä—É—Ç—ã, —á—Ç–æ–±—ã
          // –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–æ–≥ –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ —ç–∫—Ä–∞–Ω –ª–æ–≥–∏–Ω–∞ –ø–æ –∫–Ω–æ–ø–∫–µ "–ù–∞–∑–∞–¥".
          Navigator.of(context).pushAndRemoveUntil(
            MaterialPageRoute(builder: (context) => const HomeScreen()),
            (Route<dynamic> route) => false, // –£–¥–∞–ª—è–µ–º –≤—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –º–∞—Ä—à—Ä—É—Ç—ã
          );
        }
      }
    });

    return Scaffold(
      appBar: AppBar(
        backgroundColor: Colors.yellow,
        title: Text("–í—Ö–æ–¥"),
        centerTitle: true,
      ),
      body: Padding(
        padding: const EdgeInsets.all(16.0),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          crossAxisAlignment: CrossAxisAlignment.stretch,
          children: <Widget>[
            TextField(
              controller: _loginController,
              decoration: const InputDecoration(
                labelText: '–õ–æ–≥–∏–Ω',
                border: OutlineInputBorder(),
                prefixIcon: Icon(Icons.person),
              ),
              keyboardType: TextInputType.emailAddress,
            ),

            const SizedBox(height: 16.0),
            TextField(
              controller: _passwordController,
              decoration: const InputDecoration(
                labelText: '–ü–∞—Ä–æ–ª—å',
                border: OutlineInputBorder(),
                prefixIcon: Icon(Icons.lock),
              ),
              obscureText: true,
            ),
            const SizedBox(height: 30),

            ElevatedButton(
              onPressed: (isLoggedIn || isLoading)
                  ? null
                  : () => _performLogin(ref, context),
              style: ElevatedButton.styleFrom(
                padding: const EdgeInsets.symmetric(vertical: 16.0),
              ),
              child: isLoading
                  ? const SizedBox(
                      width: 24,
                      height: 24,
                      child: CircularProgressIndicator(
                        color: Colors.white,
                        strokeWidth: 2.0,
                      ),
                    )
                  : Text(
                      isLoggedIn ? '–í—ã –≤–æ—à–ª–∏ –≤ —Å–∏—Å—Ç–µ–º—É' : '–í–æ–π—Ç–∏',
                      style: const TextStyle(fontSize: 18),
                    ),
            ),
          ],
        ),
      ),
    );
  }

  // lib/presentation/screens/login_screen.dart (–≤–Ω—É—Ç—Ä–∏ _performLogin)

  void _performLogin(WidgetRef ref, BuildContext context) async {
    ref
        .read(authNotifierProvider.notifier)
        .login(_loginController.text, _passwordController.text);
  }
}
